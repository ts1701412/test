<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="icon" type="image/png" href="../src/icon.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>For the only one</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.6.1629159505/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>

    <style>
        :root { --bg-gradient: radial-gradient(circle at center, #1a0b1a 0%, #000000 100%); }
        body { 
            margin: 0; overflow: hidden; 
            background-color: #000000; background-image: var(--bg-gradient); 
            font-family: 'Noto Serif SC', serif; color: white; 
            user-select: none; -webkit-tap-highlight-color: transparent;
            touch-action: none;
        }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; cursor: grab; }
        #canvas-container:active { cursor: grabbing; }
        
        /* ç¿»è½¬å¡ç‰‡ */
        .flip-card { background-color: transparent; perspective: 1000px; }
        .flip-card-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform-style: preserve-3d;
        }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back {
            position: absolute; width: 100%; height: 100%;
            -webkit-backface-visibility: hidden; backface-visibility: hidden;
            border-radius: 1.2rem; overflow: hidden;
        }
        .flip-card-back { transform: rotateY(180deg); }

        /* UI å±‚ */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 1.5rem; box-sizing: border-box; transition: opacity 0.5s; }
        .interactive-element { pointer-events: auto; cursor: pointer; }
        .input_video { display: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        
        /* å¯åŠ¨é¡µæ ·å¼ */
        #start-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 9999; 
            display: flex; justify-content: center; align-items: center; 
            pointer-events: auto;
            transition: opacity 0.8s ease, visibility 0.8s;
        }
        #start-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        .start-card {
            background: rgba(20, 10, 20, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 105, 180, 0.3);
            box-shadow: 0 0 50px rgba(255, 105, 180, 0.2);
        }

        #blow-meter-container { position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); width: 280px; height: 12px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; opacity: 0; transition: opacity 0.5s; }
        #blow-meter-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a9e 0%, #ff69b4 100%); border-radius: 10px; transition: width 0.1s linear; box-shadow: 0 0 15px #ff69b4; }
        #blow-hint { position: absolute; bottom: 18%; width: 100%; text-align: center; font-size: 14px; color: rgba(255,255,255,0.8); text-shadow: 0 2px 4px rgba(0,0,0,0.8); opacity: 0; transition: opacity 0.5s; }

        #surprise-layer { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 80; pointer-events: none; transition: background 0.5s ease; }
        #surprise-layer.hidden { display: none !important; }
        #surprise-layer.active { pointer-events: auto; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }

        .font-handwriting { font-family: 'Dancing Script', cursive; }
        .pop-in { animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .safe-click-area { z-index: 90; position: relative; touch-action: manipulation; }
        .neon-text { text-shadow: 0 0 10px rgba(255,105,180,0.7), 0 0 20px rgba(255,105,180,0.5); }

        #floating-gift-btn {
            position: absolute; bottom: 30px; right: 30px; z-index: 200; width: 60px; height: 60px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 105, 180, 0.5);
            display: flex; justify-content: center; align-items: center; font-size: 30px; cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 105, 180, 0.4); animation: float-btn 3s ease-in-out infinite;
            transition: transform 0.3s, background 0.3s; pointer-events: auto;
        }
        #floating-gift-btn:hover { transform: scale(1.1) rotate(10deg); background: rgba(255, 105, 180, 0.3); }
        #floating-gift-btn.hidden { display: none !important; }
        @keyframes float-btn { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        #top-banner {
            position: absolute; top: 15%; left: 0; width: 100%;
            text-align: center; pointer-events: none; z-index: 5;
            animation: float-banner 4s ease-in-out infinite;
        }
        #top-banner.hidden { display: none !important; }
        .banner-text {
            font-family: 'Dancing Script', cursive;
            background: linear-gradient(to right, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            filter: drop-shadow(0 0 10px rgba(255,192,203,0.8));
        }
        @keyframes float-banner { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }

        #protocol-warning {
            position: fixed; top: 0; left: 0; width: 100%; background: #ff4444; color: white;
            text-align: center; padding: 10px; z-index: 10000; font-size: 14px; display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        #cam-preview-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #cam-preview-container:hover {
            transform: scale(1.05);
            opacity: 1;
        }
        
        @keyframes neon-pulse {
            0%, 100% { text-shadow: 0 0 10px rgba(255,105,180,0.7), 0 0 20px rgba(255,105,180,0.5); }
            50% { text-shadow: 0 0 20px rgba(255,105,180,0.9), 0 0 30px rgba(255,105,180,0.7), 0 0 40px rgba(255,105,180,0.5); }
        }
        .neon-pulse { animation: neon-pulse 2s infinite; }

        /* éšè—çš„æ—¥å¿—å®¹å™¨ */
        #debug-console { display: none; }

        /* æ»šåŠ¨æ–‡å­—åŒºåŸŸæ ·å¼ */
        .scrollable-text {
            max-height: 240px; /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto;  /* å…è®¸å‚ç›´æ»šåŠ¨ */
            padding-right: 10px; /* ç»™æ»šåŠ¨æ¡ç•™ç‚¹ç©º */
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: rgba(255,105,180,0.5) transparent; /* Firefox */
        }
        /* Chrome/Safari æ»šåŠ¨æ¡æ ·å¼ */
        .scrollable-text::-webkit-scrollbar {
            width: 4px;
        }
        .scrollable-text::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollable-text::-webkit-scrollbar-thumb {
            background-color: rgba(255, 105, 180, 0.5);
            border-radius: 10px;
        }

        /* ===== ç…§ç‰‡æ ·å¼ï¼ˆé‡‘å±è¾¹æ¡†ï¼‰ ===== */
        #galaxy-photo {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 300px;
            height: 400px;
            object-fit: cover;
            border: 8px solid #e0c060;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.5);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1000;
            pointer-events: none; /* é»˜è®¤ä¸å…è®¸äº¤äº’ï¼Œæ˜¾ç¤ºåæ”¹ä¸º auto */
        }
        #galaxy-photo.active {
            transform: translate(-50%, -50%) scale(1);
        }
        #galaxy-photo.active.interactive {
            pointer-events: auto; /* æ˜¾ç¤ºæ—¶å…è®¸æ»‘åŠ¨ */
        }

        /* ===== å½±ç‰‡æ¨¡å¼æ ·å¼ ===== */
        #video-mode-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: none;
            background: black;
        }
        #video-mode-container.active {
            display: block;
        }
        #video-player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: black;
        }
        #video-text {
            position: absolute;
            left: 5%;
            top: 50%;
            transform: translateY(-50%);
            max-width: 40%;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 2100;
            /* å­—ä½“ï¼šç»†æ˜ä½“ + åå¤‡å­—ä½“ */
            font-family: 'MingLiU', 'PMingLiU', 'ç´°æ˜é«”', 'Noto Serif SC', serif;
            color: #E6E6FA;
            font-size: 0.5rem;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* å³ä¸‹è§’æ‰‹åŠ¿æ¨¡æ‹ŸæŒ‰é’®å·²è¢«ç§»é™¤ (YA å’Œ OK æŒ‰é’®) */
    </style>
</head>
<body>
    
    <div id="debug-console"></div>

    <div id="protocol-warning">
        âš ï¸ æ£€æµ‹åˆ°æ‚¨ç›´æ¥æ‰“å¼€äº†HTMLæ–‡ä»¶ (file://)ã€‚<br>æ‘„åƒå¤´å’Œéº¦å…‹é£å°†è¢«æ‹¦æˆªã€‚<br>
        <b>è¯·åœ¨ VS Code ä¸­å®‰è£… "Live Server" æ’ä»¶å¹¶ä½¿ç”¨ "Open with Live Server" è¿è¡Œã€‚</b>
    </div>

    <!-- å¤šé¦–éŸ³æ¨‚å…ƒç´  -->
    <audio id="bgm-main" loop preload="auto">
        <source src="./src/bgm_main.mp3" type="audio/mpeg">
    </audio>
    <audio id="bgm-celebration" loop preload="auto">
        <source src="./src/bgm_celebration.mp3" type="audio/mpeg">
    </audio>
    <audio id="bgm-galaxy" loop preload="auto">
        <source src="./src/bgm_galaxy.mp3" type="audio/mpeg">
    </audio>
    <audio id="bgm-video" loop preload="auto">
        <source src="./src/bgm_video.mp3" type="audio/mpeg">
    </audio>

    <video class="input_video" playsinline></video>
    <div id="canvas-container"></div>
    
    <button id="floating-gift-btn" class="hidden safe-click-area" title="æŸ¥çœ‹ç¥ç¦">ğŸ</button>

    <!-- é“¶æ²³ç…§ç‰‡ -->
    <img id="galaxy-photo" src="./src/1.jpg" alt="Birthday Photo" crossorigin="anonymous">

    <!-- ===== å½±ç‰‡æ¨¡å¼å®¹å™¨ï¼ˆæ— æ§åˆ¶æ¡ï¼Œè‡ªåŠ¨æ’­æ”¾ï¼‰ ===== -->
    <div id="video-mode-container">
        <!-- ç§»é™¤ autoplayï¼Œæ·»åŠ  preload="none" é¿å…é¢„åŠ è½½å£°éŸ³ -->
        <video id="video-player" src="./src/video.mp4" playsinline loop preload="none"></video>
        <div id="video-text"></div>
    </div>

    <!-- å¯åŠ¨é¡µ -->
    <div id="start-overlay">
        <div class="text-center max-w-md p-8 glass-panel start-card mx-4 animate-float">
            <h1 class="text-6xl mb-2 font-handwriting text-transparent bg-clip-text bg-gradient-to-r from-pink-300 to-purple-400 drop-shadow-lg">For the only one</h1>
            <div class="space-y-4 text-gray-200 text-lg mb-8 font-light">
                <p>â˜ï¸ <b>é»æ“Šé€²å…¥å°ˆå±¬é€šé“</b> å°‡å–šé†’é­”æ³•</p>
                        <p id="mouse-hint" class="hidden text-sm text-pink-300">ğŸ–±ï¸ æœªæ£€æµ‹åˆ°æ‘„åƒå¤´ï¼Œè¯·ä½¿ç”¨é¼ æ ‡å·¦é”®æ§åˆ¶èšé›†/æ•£å¼€ï¼Œé”®ç›˜1/2/Oæ¨¡æ‹Ÿæ‰‹åŠ¿</p>
            </div>
            <button id="start-btn" class="safe-click-area px-12 py-4 bg-gradient-to-r from-pink-600 to-purple-700 rounded-full font-bold text-xl hover:scale-105 active:scale-95 transition transform shadow-[0_0_20px_rgba(255,105,180,0.5)] text-white border border-white/20 cursor-pointer z-50">
                é€²å…¥å°ˆå±¬é€šé“
            </button>
            <div id="loading-text" class="hidden mt-4 text-pink-300 text-sm">æ­£åœ¨ç¼–ç»‡æ˜Ÿå…‰...</div>
        </div>
    </div>

    <div id="blow-hint"><p class="text-lg font-bold text-pink-200 mb-1">å°è‘—éº¥å…‹é¢¨å¹æ°£</p><p class="text-xs text-gray-400">(å¦‚æœéº¦å…‹é£ä¸çµå¯ä»¥å°è¯•ç”µè„‘é•¿æŒ‰ç©ºæ ¼ Â· æ‰‹æœºé•¿æŒ‰å±å¹•)</p></div>
    <div id="blow-meter-container"><div id="blow-meter-bar"></div></div>

    <div id="top-banner" class="hidden">
        <h1 class="text-6xl md:text-8xl banner-text">For the only one</h1>
        <p class="text-pink-200/70 text-lg mt-2 tracking-widest uppercase">Wishing you happiness every day</p>
    </div>

    <!-- UI å±‚ -->
    <div id="ui-layer" style="display: none;">
        <div class="flex justify-between items-start w-full">
            <div class="glass-panel px-4 py-2">
                <div id="status-dot" class="inline-block w-2 h-2 rounded-full bg-red-500 mr-2 shadow-[0_0_8px_red]"></div>
                <span id="status-text" class="text-xs md:text-sm text-gray-300 tracking-wider">SYSTEM READY</span>
            </div>
            <div class="flex gap-2">
                <button id="music-btn" class="interactive-element p-3 glass-panel hover:bg-white/20 transition rounded-full active:scale-90">ğŸµ</button>
            </div>
        </div>
        
        <div id="center-instruction" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none w-full z-0">
            <div class="flex items-center justify-center gap-4 mb-2">
                <span id="hand-icon" class="text-6xl animate-bounce">ğŸ‘‹</span>
                <h2 id="instruction-text" class="text-6xl md:text-8xl font-bold text-white neon-pulse transition-all duration-700">èˆ‰èµ·æ‰‹</h2>
            </div>
            <p id="sub-instruction" class="mt-4 text-xl md:text-2xl text-pink-200/80 font-light tracking-[0.3em]">è®“é­”æ³•ç™¼ç”Ÿ</p>
        </div>

        <!-- æ‘„åƒå¤´é¢„è§ˆæ¡† -->
        <div id="cam-preview-container" class="absolute bottom-6 left-6 z-50 opacity-90 hover:opacity-100">
            <div class="glass-panel p-2 rounded-xl border border-white/10 shadow-[0_8px_32px_rgba(0,0,0,0.5)]">
                <div class="relative w-36 h-28 bg-black/40 rounded-lg overflow-hidden border border-white/5">
                     <canvas id="output_canvas" width="160" height="120" class="w-full h-full object-cover transform scale-x-[-1]"></canvas>
                     <div class="absolute top-2 right-2 flex items-center gap-1 bg-black/60 px-1.5 py-0.5 rounded-full backdrop-blur-sm">
                        <div id="cam-status-dot" class="w-1.5 h-1.5 rounded-full bg-red-500 transition-colors duration-300"></div>
                        <span id="cam-status-text" class="text-[8px] text-red-400 font-mono">NO HAND</span>
                     </div>
                </div>
                <div class="text-center mt-1.5">
                    <p class="text-[10px] text-pink-200/70 tracking-widest uppercase scale-90">Camera View</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æƒŠå–œå±‚ -->
    <div id="surprise-layer" class="hidden">
        <button id="reveal-btn" class="safe-click-area hidden px-10 py-5 bg-white text-pink-600 rounded-full font-bold text-2xl shadow-[0_0_60px_rgba(255,105,180,0.8)] hover:scale-105 transition-transform duration-300 animate-float">ğŸ æ‰“é–‹å¡ç‰‡</button>
        
        <!-- å¡ç‰‡ï¼ˆåªä¿ç•™ç¬¬ä¸€é¡µï¼Œè¾¹æ¡†çº¿å›ºå®šï¼‰ -->
        <div id="flip-card-container" class="hidden glass-panel w-full max-w-sm md:max-w-md aspect-[3/4] mx-6 pop-in">
            <div class="bg-gradient-to-br from-purple-500/40 to-blue-600/40 border border-white/30 p-1 rounded-[1.5rem] h-full">
                <div class="bg-black/90 rounded-[1rem] p-8 h-full flex flex-col items-center justify-center backdrop-blur-md">
                    <div class="mb-4 text-5xl animate-bounce text-center">ğŸ’Œ</div>
                    <h3 class="text-2xl font-bold text-pink-300 mb-6 font-handwriting text-center">çµ¦å”¯ä¸€çš„ä½ </h3>
                    <div id="typewriter-text-1" class="text-left text-gray-200 space-y-4 font-light leading-7 text-sm md:text-base border-l-2 border-pink-500/50 pl-4 mb-4 flex-grow scrollable-text w-full" style="text-align: left;"></div>
                    <button id="close-card-btn" class="safe-click-area px-6 py-2 mt-auto rounded-full bg-white/10 text-pink-200 hover:bg-white/20 transition text-sm flex items-center justify-center mx-auto">
                       ğŸ‘‰ <span class="ml-2">æ”¶èµ·å¡ç‰‡</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- è°ƒè¯•æ—¥å¿—å·¥å…· ---
        const debugConsole = document.getElementById('debug-console');
        function log(msg) {
            if (debugConsole) {
                const time = new Date().toLocaleTimeString();
                debugConsole.innerHTML += `[${time}] ${msg}<br>`;
            }
            console.log(msg);
        }

        const IS_MOBILE = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (window.location.protocol === 'file:') {
            document.getElementById('protocol-warning').style.display = 'block';
        }

        // ===== ç…§ç‰‡åˆ—è¡¨ =====
        const photoList = [
            './src/1.jpg',
            './src/2.jpg',
            './src/3.jpg',
            './src/4.jpg',
            './src/5.jpg'
        ];

        // ===== å½±ç‰‡æ–‡å­—åˆ—è¡¨ï¼ˆæ‰“å­—æœºç”¨ï¼‰=====
        const videoMessages = [
            "æœ‰äº›æ„Ÿæƒ…ï¼Œæ‚„æ‚„ä¾†åˆ°ã€‚",
            "ä¸å¼µæšï¼Œå»è®“æ—¥å¸¸æœ‰äº†æº«åº¦ã€‚",
            "",
            "æˆ‘çš„å–œæ­¡ï¼Œ",
            "é¡˜åœ¨ä½ é‡åˆ°ä½è°·æ™‚ï¼Œ",
            "æˆç‚ºä¸€é»æº«æš–èˆ‡åŠ›é‡ã€‚",
            "è‡³å°‘æˆ‘ï¼Œ",
            "ä¸€ç›´è¢«ä½ çš„é­…åŠ›æ‰€å¸å¼•",
            "â€”â€”æ›¾ç¶“å¦‚æ­¤ï¼Œ",
            "æœªä¾†äº¦æœƒå¦‚æ­¤ã€‚",
        ];

        // ===== å¡ç‰‡ç¥ç¦è¯­ï¼ˆç¬¬ä¸€é¡µï¼‰=====
        const wishes_part1 = [
            "â¤ï¸æ¯ä¸€å€‹å ´æ™¯éƒ½æœ‰â¤ï¸",
            "ä¸€é¦–å°ˆå±¬çš„æ­Œæ›²ğŸµ",
            "é€²å…¥å ´æ™¯éœ€å°æ‡‰æ‰‹å‹¢ğŸ˜",
            "â˜ï¸é€²å…¥æ˜Ÿè¾°ğŸ¤å¯æŠ“å–åœ–ç‰‡",
            "âœŒï¸é€²å…¥ğ¦à¼˜â‹†è´è¶æµ·",
            "ï½¡ï¾Ÿï¾Ÿï½¥ï½¡ï½¥ï¾Ÿï¾Ÿï½¡ ",
            "ã€‚  loveã€‚",
            "ã€€ï¾Ÿï½¥ï½¡ï½¥ï¾Ÿ",
        ];

        // --- å…¨å±€å˜é‡ ---
        const CAKE_THEME = { bottom: "#FFD700", top: "#FFA500", cream: "#FFFFFF" }; // ä¿ç•™ä½†ä¸å†ä½¿ç”¨
        const VISUAL_CONFIG = { particleCount: IS_MOBILE ? 4000 : 7500, color: 0xff69b4, blowThreshold: 25, blowMaxDuration: 100 };
        const STATE = { INTRO: -1, IDLE: 0, COUNTDOWN: 1, CAKE: 2, BLOWING: 3, CELEBRATION: 4 };
        
        let currentState = STATE.INTRO;
        let interactionMode = 0; 
        
        let particlesData = [];
        let scene, camera, renderer, particleSystem;
        let time = 0;
        let shapeCache = {}; 
        let blowProgress = 0;
        let isSpacePressed = false; 
        let isTouching = false; 
        
        let rotationVelocity = 0;
        let isDragging = false;
        let previousMouseX = 0;
        let lastHandX = 0;
        let autoRotateSpeed = 0.001;

        // --- æ‰‹åŠ¿çŠ¶æ€ ---
        let handGesture = 'unknown';
        let lastOneGesture = false;
        let lastOkGesture = false;
        let lastYaGesture = false;

        // --- é“¶æ²³æ¨¡å¼ ---
        let galaxyMode = false;
        let galaxyTargets = null;

        // --- OKæ‰‹åŠ¿ç…§ç‰‡æ§åˆ¶ï¼ˆä¿®æ”¹ä¸ºå¸¸æ˜¾ï¼Œæ”¯æŒæ»‘åŠ¨ï¼‰---
        let photoActive = false;          // ç…§ç‰‡æ˜¯å¦æ˜¾ç¤º
        let currentPhotoIndex = 0;        // å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡ç´¢å¼•ï¼ˆä»…åœ¨é“¶æ²³æ¨¡å¼æœ‰æ•ˆï¼‰
        const photoElement = document.getElementById('galaxy-photo');

        // ===== å½±ç‰‡æ¨¡å¼ç›¸å…³ =====
        let videoMode = false;
        let typewriterInterval = null;
        let typewriterTimeout = null; // æ®µé—´æš‚åœè¶…æ—¶ï¼ˆä¸å†ä½¿ç”¨ï¼Œä¿ç•™ä»¥é˜²ä¸‡ä¸€ï¼‰
        const videoContainer = document.getElementById('video-mode-container');
        const videoPlayer = document.getElementById('video-player');
        const videoText = document.getElementById('video-text');

        // ===== éŸ³æ¨‚æ§åˆ¶ =====
        const bgmMain = document.getElementById('bgm-main');
        const bgmCelebration = document.getElementById('bgm-celebration');
        const bgmGalaxy = document.getElementById('bgm-galaxy');
        const bgmVideo = document.getElementById('bgm-video');
        let currentMusic = null;

        // ===== æ‰‹åŠ¿åœºæ™¯åˆ‡æ¢å†·å´æ—¶é—´ =====
        let lastOneSwitchTime = 0;      // æ‰‹åŠ¿â€œoneâ€ä¸Šæ¬¡åˆ‡æ¢æ—¶é—´
        let lastYaSwitchTime = 0;       // æ‰‹åŠ¿â€œyaâ€ä¸Šæ¬¡åˆ‡æ¢æ—¶é—´

        // ===== é¢„åŠ è½½æ‰€æœ‰éŸ³ä¹ï¼Œåœ¨ç”¨æˆ·æ‰‹åŠ¿åæ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡ =====
        function preloadAllMusic() {
            const audios = [bgmMain, bgmCelebration, bgmGalaxy, bgmVideo];
            audios.forEach(audio => {
                if (audio) {
                    audio.load(); // ç¡®ä¿åŠ è½½
                    // å°è¯•æ’­æ”¾å¹¶ç«‹å³æš‚åœï¼Œä»¥æ¿€æ´»éŸ³é¢‘ï¼ˆéœ€è¦ç”¨æˆ·æ‰‹åŠ¿ï¼‰
                    audio.play().then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        log(`é¢„åŠ è½½æˆåŠŸ: ${audio.id}`);
                    }).catch(e => log(`é¢„åŠ è½½å¤±è´¥ ${audio.id}: ${e}`));
                }
            });
        }

        // å¢å¼ºç‰ˆéŸ³ä¹æ’­æ”¾ï¼šå¦‚æœå¤±è´¥åˆ™é‡è¯•ä¸€æ¬¡ï¼Œå¹¶ç¡®ä¿ä¸»åœºæ™¯éŸ³ä¹åœ¨å¡ç‰‡æ‰“å¼€æ—¶å¼ºåˆ¶æ’­æ”¾
        function playMusic(musicElement, retry = true) {
            if (!musicElement) return;
            
            // å¦‚æœå·²ç»æ˜¯å½“å‰éŸ³ä¹ï¼Œç¡®ä¿éŸ³é‡å¹¶å°è¯•æ’­æ”¾ï¼ˆå¦‚æœæš‚åœï¼‰
            if (currentMusic === musicElement) {
                musicElement.volume = 1.0;
                if (musicElement.paused) {
                    musicElement.play().catch(e => {
                        log(`æ’­æ”¾å½“å‰éŸ³ä¹å¤±è´¥ (é‡è¯•): ${e}`);
                        if (retry) {
                            setTimeout(() => playMusic(musicElement, false), 300);
                        }
                    });
                }
                return;
            }
            
            // åœæ­¢å½“å‰éŸ³ä¹
            if (currentMusic && currentMusic !== musicElement) {
                currentMusic.pause();
                currentMusic.currentTime = 0;
            }
            
            musicElement.volume = 1.0; // è°ƒå¤§éŸ³é‡
            musicElement.play().then(() => {
                log(`æ’­æ”¾éŸ³ä¹: ${musicElement.id}`);
            }).catch(e => {
                log(`æ’­æ”¾éŸ³ä¹å¤±è´¥ ${musicElement.id}: ${e}`);
                if (retry) {
                    // å°è¯•é‡æ–°åŠ è½½å¹¶é‡è¯•ä¸€æ¬¡
                    musicElement.load();
                    setTimeout(() => playMusic(musicElement, false), 500);
                }
            });
            currentMusic = musicElement;
        }

        function stopAllMusic() {
            if (currentMusic) {
                currentMusic.pause();
                currentMusic.currentTime = 0;
                currentMusic = null;
            }
        }

        function fadeAudioIn() {
            playMusic(bgmMain);
        }

        function successCelebration() {
            log('è®¸æ„¿æˆåŠŸï¼æ’­æ”¾åº†ç¥åŠ¨ç”»');
            currentState = STATE.CELEBRATION;
            ui.statusText.innerText = "WISH GRANTED";
            ui.blowMeter.style.opacity = '0';
            ui.blowHint.style.opacity = '0';
            
            document.body.classList.add('shake-screen');
            setTimeout(() => document.body.classList.remove('shake-screen'), 500);

            particlesData.forEach(p => {
                if (p.type === 'heart' || p.type === 'cake') {
                    p.target.y += Math.sin(p.current.x * 0.5) * 0.5; 
                } else if (p.type !== 'bg') {
                    p.type = 'bg'; 
                }
            });

            playMusic(bgmCelebration); // åº†ç¥åŠ¨ç”»æ’­æ”¾åº†ç¥éŸ³ä¹

            setTimeout(() => {
                ui.surpriseLayer.classList.remove('hidden');
                ui.surpriseLayer.classList.add('active');
                ui.revealBtn.classList.remove('hidden');
            }, 1500);
        }

        function toggleVideoMode(enable) {
            if (enable === videoMode) return;
            videoMode = enable;
            if (videoMode) {
                // è¿›å…¥è§†é¢‘æ¨¡å¼ï¼Œå…³é—­é“¶æ²³æ¨¡å¼
                galaxyMode = false;
                galaxyTargets = null;
                hidePhoto(); // éšè—ç…§ç‰‡
                
                videoContainer.classList.add('active');
                particleSystem.visible = false;
                // è§†é¢‘å¼€å§‹æ’­æ”¾ï¼ˆå·²ç§»é™¤autoplayï¼Œæ­¤å¤„æ‰‹åŠ¨æ’­æ”¾ï¼‰
                videoPlayer.play().catch(e => log('è§†é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥: ' + e));
                startTypewriter();
                stopAllMusic();
                playMusic(bgmVideo);
            } else {
                videoContainer.classList.remove('active');
                particleSystem.visible = true;
                videoPlayer.pause();
                // æ¸…é™¤æ‰“å­—æœºç›¸å…³å®šæ—¶å™¨
                if (typewriterInterval) {
                    clearInterval(typewriterInterval);
                    typewriterInterval = null;
                }
                if (typewriterTimeout) {
                    clearTimeout(typewriterTimeout);
                    typewriterTimeout = null;
                }
                videoText.textContent = '';
                // æ ¹æ®å½“å‰çŠ¶æ€æ¢å¤éŸ³ä¹
                if (galaxyMode) {
                    playMusic(bgmGalaxy);
                } else if (currentState === STATE.CELEBRATION) {
                    playMusic(bgmCelebration);
                } else {
                    playMusic(bgmMain);
                }
            }
        }

        // ç…§ç‰‡ç›¸å…³è¾…åŠ©å‡½æ•°
        function showPhoto(index) {
            if (!galaxyMode) return; // åªåœ¨é“¶æ²³æ¨¡å¼æ˜¾ç¤º
            photoElement.src = photoList[index];
            photoActive = true;
            photoElement.classList.add('active');
            photoElement.classList.add('interactive'); // å…è®¸è§¦æ‘¸äº‹ä»¶
        }

        function hidePhoto() {
            photoActive = false;
            photoElement.classList.remove('active');
            photoElement.classList.remove('interactive');
        }

        function nextPhoto() {
            if (!galaxyMode || !photoActive) return;
            currentPhotoIndex = (currentPhotoIndex + 1) % photoList.length;
            photoElement.src = photoList[currentPhotoIndex];
        }

        function prevPhoto() {
            if (!galaxyMode || !photoActive) return;
            currentPhotoIndex = (currentPhotoIndex - 1 + photoList.length) % photoList.length;
            photoElement.src = photoList[currentPhotoIndex];
        }

        // ä¸ºç…§ç‰‡æ·»åŠ æ»‘åŠ¨åˆ‡æ¢äº‹ä»¶
        (function initPhotoSwipe() {
            let touchStartX = 0;
            let touchEndX = 0;
            const minSwipeDistance = 50; // æœ€å°æ»‘åŠ¨è·ç¦»

            photoElement.addEventListener('touchstart', (e) => {
                if (!galaxyMode || !photoActive) return;
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });

            photoElement.addEventListener('touchend', (e) => {
                if (!galaxyMode || !photoActive) return;
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const delta = touchEndX - touchStartX;
                if (Math.abs(delta) < minSwipeDistance) return;
                if (delta > 0) {
                    // å³æ»‘ -> ä¸Šä¸€å¼ 
                    prevPhoto();
                } else {
                    // å·¦æ»‘ -> ä¸‹ä¸€å¼ 
                    nextPhoto();
                }
            }
        })();

        // æ‰“å­—æœºæ•ˆæœï¼šæ¯æ®µæ–‡å­—ä¾æ¬¡æ‰“å‡ºï¼Œä¿ç•™ä¸æ¶ˆå¤±ï¼Œæ®µè½é—´è‡ªåŠ¨æ¢è¡Œï¼Œå…¨éƒ¨æ‰“å®Œååœæ­¢
        function startTypewriter() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (typewriterInterval) {
                clearInterval(typewriterInterval);
                typewriterInterval = null;
            }
            if (typewriterTimeout) {
                clearTimeout(typewriterTimeout);
                typewriterTimeout = null;
            }
            videoText.textContent = ''; // å¼€å§‹æ—¶æ¸…ç©º

            let messageIndex = 0;
            let charIndex = 0;
            const speed = 350; // æ‰“å­—é€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ç¬¦ï¼‰

            function typeNext() {
                if (messageIndex >= videoMessages.length) {
                    // æ‰€æœ‰æ®µè½å·²æ‰“å®Œï¼Œåœæ­¢
                    if (typewriterInterval) {
                        clearInterval(typewriterInterval);
                        typewriterInterval = null;
                    }
                    return;
                }
                const currentMessage = videoMessages[messageIndex];

                if (charIndex < currentMessage.length) {
                    // é€å­—è¾“å‡º
                    videoText.textContent += currentMessage.charAt(charIndex);
                    charIndex++;
                } else {
                    // å½“å‰æ®µè½å·²æ‰“å®Œï¼Œæ·»åŠ æ¢è¡Œï¼Œå¹¶ç§»åŠ¨åˆ°ä¸‹ä¸€æ®µ
                    videoText.textContent += '\n'; // ä½¿ç”¨ \n æ¢è¡Œï¼ˆéœ€é…åˆ white-space: pre-wrapï¼‰
                    messageIndex++;
                    charIndex = 0;
                    // ç»§ç»­æ‰“å­—ï¼ˆç”± interval è‡ªåŠ¨è°ƒç”¨ä¸‹ä¸€è½®ï¼‰
                }
            }

            typewriterInterval = setInterval(typeNext, speed);
        }

        // --- æ‘„åƒå¤´å¯ç”¨æ ‡å¿—åŠé¼ æ ‡æ§åˆ¶æ ‡å¿— ---
        let cameraAvailable = false;
        let useMouseControl = false;

        let audioContext, analyser;

        const ui = {
            startOverlay: document.getElementById('start-overlay'),
            uiLayer: document.getElementById('ui-layer'),
            statusText: document.getElementById('status-text'),
            statusDot: document.getElementById('status-dot'),
            mainText: document.getElementById('instruction-text'),
            subText: document.getElementById('sub-instruction'),
            handIcon: document.getElementById('hand-icon'),
            blowMeter: document.getElementById('blow-meter-container'),
            blowBar: document.getElementById('blow-meter-bar'),
            blowHint: document.getElementById('blow-hint'),
            surpriseLayer: document.getElementById('surprise-layer'),
            revealBtn: document.getElementById('reveal-btn'),
            floatingGiftBtn: document.getElementById('floating-gift-btn'),
            cardContainer: document.getElementById('flip-card-container'), 
            topBanner: document.getElementById('top-banner'),
            startBtn: document.getElementById('start-btn'),
            loadingText: document.getElementById('loading-text'),
            camStatusDot: document.getElementById('cam-status-dot'),
            camStatusText: document.getElementById('cam-status-text'),
            mouseHint: document.getElementById('mouse-hint'),
            textContainer1: document.getElementById('typewriter-text-1'),
            closeBtn: document.getElementById('close-card-btn')
        };

        // åˆå§‹åŒ– Three.js
        initThree();

        function initThree() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.002);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 50;
            renderer = new THREE.WebGLRenderer({ antialias: !IS_MOBILE, alpha: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);
            preloadShapes();
            createParticles();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            const onStart = (x) => {
                if(interactionMode === 1) {
                    isDragging = true;
                    previousMouseX = x;
                    rotationVelocity = 0; 
                }
            };
            const onMove = (x) => {
                if(isDragging && interactionMode === 1) {
                    const delta = x - previousMouseX;
                    const sensitivity = IS_MOBILE ? 0.015 : 0.008; 
                    rotationVelocity = delta * sensitivity;
                    particleSystem.rotation.y += rotationVelocity;
                    previousMouseX = x;
                }
            };
            const onEnd = () => { isDragging = false; };

            container.addEventListener('mousedown', (e) => onStart(e.clientX));
            window.addEventListener('mousemove', (e) => onMove(e.clientX));
            window.addEventListener('mouseup', onEnd);

            container.addEventListener('touchstart', (e) => onStart(e.touches[0].clientX), {passive: false});
            window.addEventListener('touchmove', (e) => {
                if(isDragging) e.preventDefault(); 
                onMove(e.touches[0].clientX);
            }, {passive: false});
            window.addEventListener('touchend', onEnd);
            
            render();
        }

        function createParticles() {
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(VISUAL_CONFIG.particleCount * 3);
            const colors = new Float32Array(VISUAL_CONFIG.particleCount * 3);
            const sizes = new Float32Array(VISUAL_CONFIG.particleCount);
            particlesData = [];
            const c = new THREE.Color(VISUAL_CONFIG.color);

            for (let i = 0; i < VISUAL_CONFIG.particleCount; i++) {
                const x = (Math.random() - 0.5) * 300;
                const y = (Math.random() - 0.5) * 300;
                const z = (Math.random() - 0.5) * 200;
                positions[i * 3] = x; positions[i * 3 + 1] = y; positions[i * 3 + 2] = z;
                colors[i * 3] = c.r; colors[i * 3 + 1] = c.g; colors[i * 3 + 2] = c.b;
                sizes[i] = Math.random() * 2;
                particlesData.push({
                    current: new THREE.Vector3(x, y, z),
                    target: new THREE.Vector3(x, y, z),
                    baseTarget: new THREE.Vector3(x, y, z),
                    velocity: new THREE.Vector3(0, 0, 0),
                    type: 'bg', layer: null, targetColor: c.clone(),
                    noiseOffset: Math.random() * 100,
                    angle: Math.random() * Math.PI * 2, 
                    radius: 20 + Math.random() * 40,
                    orbitSpeed: (Math.random() - 0.5) * 0.02
                });
            }
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
            const material = new THREE.PointsMaterial({ size: 1.2, vertexColors: true, map: getCircleTexture(), transparent: true, opacity: 0.8, depthWrite: false, blending: THREE.AdditiveBlending });
            particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);
        }

        function getCircleTexture() {
            const c = document.createElement('canvas'); c.width=64; c.height=64;
            const ctx=c.getContext('2d');
            const g=ctx.createRadialGradient(32,32,0,32,32,32);
            g.addColorStop(0,'rgba(255,255,255,1)'); g.addColorStop(1,'rgba(255,255,255,0)');
            ctx.fillStyle=g; ctx.fillRect(0,0,64,64);
            return new THREE.CanvasTexture(c);
        }

        // ==================== çˆ±å¿ƒç”Ÿæˆ ====================
        function getShapePoints(type, text) {
            const points = [];
            if (type === 'text') {
                // ä¸å†ä½¿ç”¨æ•°å­—ç²’å­ï¼Œä½†ä¿ç•™å‡½æ•°ä»¥é˜²ä¸‡ä¸€
                return points;
            } else if (type === 'cake') {
                const totalCount = IS_MOBILE ? 2000 : 3500;
                // çˆ±å¿ƒå¤§å° 1.2
                const scale = 1.2;

                for (let i = 0; i < totalCount; i++) {
                    const u = Math.random() * Math.PI * 2;
                    const v = Math.random() * Math.PI * 2;

                    const x0 = 16 * Math.pow(Math.sin(u), 3);
                    const y0 = 13 * Math.cos(u) - 5 * Math.cos(2*u) - 2 * Math.cos(3*u) - Math.cos(4*u);

                    const rOffset = 0.9 + Math.random() * 0.2;

                    const x = x0 * Math.cos(v) * scale * rOffset;
                    const y = y0 * scale * rOffset;
                    const z = x0 * Math.sin(v) * scale * rOffset;

                    points.push({
                        vec: new THREE.Vector3(x, y, z),
                        type: 'heart',
                        layer: null,
                        color: new THREE.Color(0xffffff)
                    });
                }
                return points;
            }
            return points;
        }

        function preloadShapes() {
            setTimeout(() => {
                // ä»…é¢„åŠ è½½çˆ±å¿ƒå½¢çŠ¶ï¼Œç§»é™¤æ•°å­—ç²’å­
                shapeCache['cake'] = getShapePoints('cake');
                ui.loadingText.style.display = 'none';
            }, 100);
        }

        function transitionTo(key) {
            const targets = shapeCache[key] || [];
            particlesData.forEach((p, i) => {
                if (i < targets.length) {
                    p.baseTarget.copy(targets[i].vec);
                    p.target.copy(targets[i].vec);
                    p.type = targets[i].type;
                    p.layer = targets[i].layer;
                    if(targets[i].color) {
                        p.targetColor = targets[i].color.clone();
                    } else {
                        p.targetColor = new THREE.Color(0xffffff); 
                    }
                    const force = 3;
                    p.current.add(new THREE.Vector3((Math.random()-0.5)*force, (Math.random()-0.5)*force, (Math.random()-0.5)*force));
                } else {
                    const radius = 80 + Math.random() * 60;
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    const r = radius * Math.cbrt(Math.random());
                    p.baseTarget.set(
                        r * Math.sin(phi) * Math.cos(theta),
                        r * Math.cos(phi),
                        r * Math.sin(phi) * Math.sin(theta)
                    );
                    p.target.copy(p.baseTarget);
                    p.type = 'bg';
                    p.layer = null;
                    p.targetColor = new THREE.Color(0x222222);
                }
            });
        }

        function generateGalaxyTargets() {
            const targets = [];
            const colors = [];
            const armCount = 3;
            const coreRadius = 20;
            const maxRadius = 100;
            const spiralTightness = 4.0;

            for (let i = 0; i < VISUAL_CONFIG.particleCount; i++) {
                const random = (i * 9301 + 49297) % 233280 / 233280;
                const random2 = (i * 5923 + 12345) % 233280 / 233280;

                const r = coreRadius + (maxRadius - coreRadius) * Math.pow(random, 1.5);
                
                const armIndex = Math.floor(random2 * armCount);
                const baseAngle = (armIndex / armCount) * Math.PI * 2;
                
                const spiralAngle = baseAngle + (r / maxRadius) * spiralTightness * Math.PI * 2;
                const angleOffset = (Math.random() - 0.5) * 0.5;
                const theta = spiralAngle + angleOffset;
                
                const y = (Math.random() - 0.5) * 15 * (r / maxRadius + 0.5);
                
                const x = r * Math.cos(theta);
                const z = r * Math.sin(theta);
                
                targets.push(new THREE.Vector3(x, y, z));
                
                const t = (r - coreRadius) / (maxRadius - coreRadius);
                const innerColor = new THREE.Color(0x88aaff);
                const outerColor = new THREE.Color(0xffaa66);
                const col = innerColor.clone().lerp(outerColor, t);
                col.multiplyScalar(0.8 + Math.random() * 0.4);
                colors.push(col);
            }
            return { targets, colors };
        }

        function updateParticles() {
            if (videoMode) return;

            const positions = particleSystem.geometry.attributes.position.array;
            const colorsAttr = particleSystem.geometry.attributes.color.array;
            const sizes = particleSystem.geometry.attributes.size.array;
            time += 0.02;

            const heartPositions = [];
            for (let i = 0; i < VISUAL_CONFIG.particleCount; i++) {
                const p = particlesData[i];
                if (p.type === 'heart') {
                    heartPositions.push(p.current.clone());
                }
            }
            const heartCount = heartPositions.length;

            if (galaxyMode && !galaxyTargets) {
                galaxyTargets = generateGalaxyTargets();
            } else if (!galaxyMode) {
                galaxyTargets = null;
                // ç¦»å¼€é“¶æ²³æ¨¡å¼æ—¶éšè—ç…§ç‰‡
                if (photoActive) hidePhoto();
            }

            for (let i = 0; i < VISUAL_CONFIG.particleCount; i++) {
                const p = particlesData[i];
                let target = p.target.clone();

                // çˆ±å¿ƒï¼šæ·±çº¢è‰²
                if (p.type === 'heart') {
                    p.targetColor.set(0x8B0000);
                }

                if (currentState === STATE.INTRO) {
                    const angle = p.angle + time * 0.05;
                    const r = p.radius + Math.sin(time * 0.5 + i * 0.01) * 10;
                    target.x = Math.cos(angle) * r * 3;
                    target.z = Math.sin(angle) * r * 3;
                    target.y = p.baseTarget.y + Math.sin(time * 0.5 + target.x * 0.05) * 20; 
                    const hue = 0.8 + (Math.sin(time * 0.1 + target.x * 0.01) * 0.1); 
                    p.targetColor.setHSL(hue, 0.7, 0.6);
                }
                else if (currentState === STATE.CELEBRATION && p.type === 'bg') {
                    const angle = p.angle + time * 0.1 + p.orbitSpeed;
                    const r = p.radius + Math.sin(time + i) * 5;
                    target.x = Math.cos(angle) * r;
                    target.z = Math.sin(angle) * r;
                    target.y = p.baseTarget.y + Math.sin(time + p.noiseOffset) * 2;
                    // åº†ç¥åŠ¨ç”»ï¼šæµ…ç²‰è‰²
                    p.targetColor.setHSL(0.9, 0.8, 0.7 + Math.random() * 0.3);
                } 
                else if (currentState === STATE.IDLE) {
                    const angle = p.angle + time * 0.1;
                    const r = p.radius + Math.sin(time + i * 0.01)*2;
                    target.x = Math.cos(angle) * r;
                    target.z = Math.sin(angle) * r;
                    target.y = p.baseTarget.y + Math.sin(time + target.x * 0.05) * 5; 
                    
                    // èƒŒæ™¯ç²’å­ï¼šæ·±ç°è‰²
                    if (p.type === 'bg') {
                        p.targetColor.set(0x333333);
                    }
                }

                // é“¶æ²³æ¨¡å¼è¦†ç›–æ‰€æœ‰é¢œè‰²
                if (galaxyMode && galaxyTargets) {
                    target.copy(galaxyTargets.targets[i]);
                    p.targetColor.copy(galaxyTargets.colors[i]);
                } else {
                    // éé“¶æ²³æ¨¡å¼ä¸‹çš„æ‰‹åŠ¿æ§åˆ¶
                    if (p.type === 'bg' && heartCount > 0) {
                        if (handGesture === 'fist') {
                            const targetIndex = i % heartCount;
                            target.copy(heartPositions[targetIndex]);
                        } else if (handGesture === 'palm') {
                            target.copy(p.baseTarget);
                        }
                    }
                }

                // åŠ å¿«ç²’å­èšåˆé€Ÿåº¦ï¼šå°† lerp ç³»æ•°ä» 0.02 æ”¹ä¸º 0.08
                p.current.lerp(target, 0.08);

                positions[i*3] = p.current.x;
                positions[i*3+1] = p.current.y;
                positions[i*3+2] = p.current.z;
                
                colorsAttr[i*3] += (p.targetColor.r - colorsAttr[i*3]) * 0.1;
                colorsAttr[i*3+1] += (p.targetColor.g - colorsAttr[i*3+1]) * 0.1;
                colorsAttr[i*3+2] += (p.targetColor.b - colorsAttr[i*3+2]) * 0.1;

                sizes[i] = 1.2 + Math.sin(time + i) * 0.3;
            }

            particleSystem.geometry.attributes.position.needsUpdate = true;
            particleSystem.geometry.attributes.color.needsUpdate = true;
            particleSystem.geometry.attributes.size.needsUpdate = true;
            
            if (galaxyMode) {
                particleSystem.rotation.y += 0.001;
            } else if (interactionMode === 1) {
                if (!isDragging) {
                    rotationVelocity *= 0.96; 
                    particleSystem.rotation.y += rotationVelocity + autoRotateSpeed;
                }
            } else if (currentState !== STATE.IDLE && currentState !== STATE.INTRO) {
                particleSystem.rotation.y = Math.sin(time * 0.15) * 0.15;
            } else {
                particleSystem.rotation.y = 0;
            }
        }

        // --- ä¸šåŠ¡é€»è¾‘ ---
        let transitionLock = false;

        function startSequence() {
            if (currentState !== STATE.IDLE || transitionLock) return;
            transitionLock = true;
            // éšè—æ‰‹å›¾æ ‡
            ui.handIcon.style.display = 'none';
            // ç›´æ¥è¿›å…¥å¹æ°”é˜¶æ®µï¼Œä¸å†æ˜¾ç¤ºæ•°å­—ç²’å­
            showCake();
        }

        function showCake() {
            log('å±•ç¤ºçˆ±å¿ƒï¼Œå¼€å¯å¹æ°”æ£€æµ‹');
            currentState = STATE.BLOWING;
            transitionTo('cake');
            ui.mainText.innerText = "";
            ui.subText.innerText = "";
            ui.topBanner.classList.remove('hidden'); 
            ui.statusText.innerText = "MIC LISTENING...";
            ui.blowMeter.style.opacity = '1';
            ui.blowHint.style.opacity = '1';
        }

        // æ‰“å­—æœºå‡½æ•°ï¼ˆç”¨äºå¡ç‰‡ï¼‰
        function typeWriter(textArray, containerId, speed = 50) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = "";
            let lineIndex = 0;
            let charIndex = 0;

            function type() {
                if (lineIndex < textArray.length) {
                    const currentLine = textArray[lineIndex];
                    if (charIndex < currentLine.length) {
                        container.innerHTML += currentLine.charAt(charIndex);
                        charIndex++;
                        setTimeout(type, speed);
                    } else {
                        container.innerHTML += "<br>";
                        lineIndex++;
                        charIndex = 0;
                        setTimeout(type, 300);
                    }
                    container.scrollTop = container.scrollHeight;
                }
            }
            type();
        }

        // ===== å¡ç‰‡æ§åˆ¶ =====
        ui.revealBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            ui.revealBtn.classList.add('hidden');
            ui.cardContainer.classList.remove('hidden');
            typeWriter(wishes_part1, 'typewriter-text-1');
            // å¼ºåˆ¶åˆ‡æ¢ä¸ºä¸»åœºæ™¯éŸ³ä¹ï¼ˆbgm-mainï¼‰
            log('æ‰“å¼€å¡ç‰‡ï¼Œåˆ‡æ¢åˆ°ä¸»åœºæ™¯éŸ³ä¹');
            playMusic(bgmMain);
        });

        ui.floatingGiftBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            ui.floatingGiftBtn.classList.add('hidden'); 
            ui.surpriseLayer.classList.remove('hidden'); 
            ui.surpriseLayer.classList.add('active');
            interactionMode = 0;
            ui.cardContainer.classList.remove('hidden');
            typeWriter(wishes_part1, 'typewriter-text-1');
            // æµ®åŠ¨æŒ‰é’®æ‰“å¼€å¡ç‰‡ä¹Ÿåˆ‡æ¢åˆ°ä¸»åœºæ™¯éŸ³ä¹
            log('æ‰“å¼€å¡ç‰‡ï¼ˆæµ®åŠ¨æŒ‰é’®ï¼‰ï¼Œåˆ‡æ¢åˆ°ä¸»åœºæ™¯éŸ³ä¹');
            playMusic(bgmMain);
        });

        ui.closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            ui.mainText.innerText = ""; 
            ui.surpriseLayer.classList.remove('active');
            ui.surpriseLayer.classList.add('hidden');    
            ui.floatingGiftBtn.classList.remove('hidden');
            
            interactionMode = 1; 
            transitionTo('cake'); 
            ui.statusText.innerText = "INTERACTIVE MODE: DRAG TO ROTATE";
            ui.topBanner.classList.remove('hidden');
            // å…³é—­å¡ç‰‡åæ ¹æ®é“¶æ²³æ¨¡å¼å’Œåº†ç¥çŠ¶æ€å†³å®šéŸ³ä¹
            if (galaxyMode) {
                playMusic(bgmGalaxy);
            } else {
                // æ— è®ºæ˜¯å¦åº†ç¥ï¼Œåªè¦ä¸æ˜¯é“¶æ²³æ¨¡å¼ï¼Œéƒ½æ’­æ”¾ä¸»åœºæ™¯éŸ³ä¹
                playMusic(bgmMain);
            }
        });

        ui.startBtn.addEventListener('click', async function() {
            log('ç‚¹å‡»äº†è¿›å…¥æŒ‰é’®...');
            const btn = this;
            
            if (typeof Hands === 'undefined') {
                log('è­¦å‘Š: MediaPipe åº“åŠ è½½å»¶è¿Ÿã€‚');
            }

            btn.innerHTML = '<span class="animate-pulse">Loading...</span>';
            btn.disabled = true;
            ui.loadingText.style.display = 'block';
            
            // é¢„åŠ è½½æ‰€æœ‰éŸ³ä¹ï¼Œç¡®ä¿åç»­åˆ‡æ¢é¡ºç•…
            preloadAllMusic();
            
            try {
                fadeAudioIn();
                await initAudio();
                log('éŸ³é¢‘åˆå§‹åŒ–æˆåŠŸ');
            } catch(e) {
                log('éŸ³é¢‘åˆå§‹åŒ–è­¦å‘Š: ' + e);
                ui.statusText.innerText = "AUDIO/MIC LIMITED";
            }

            try {
                log('å°è¯•å¯åŠ¨æ‘„åƒå¤´...');
                await initCamera();
                log('æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ');
                cameraAvailable = true;
                useMouseControl = false;
                ui.mouseHint.classList.add('hidden');
            } catch (e) {
                log('æ‘„åƒå¤´/MediaPipe å¤±è´¥: ' + e);
                ui.statusText.innerText = "CAMERA FAILED - USE MOUSE & KEYBOARD";
                cameraAvailable = false;
                useMouseControl = true;
                ui.mouseHint.classList.remove('hidden');
                enableMouseControl();
            }
            
            log('è¿›å…¥ä¸»ç•Œé¢...');
            currentState = STATE.IDLE;
            ui.startOverlay.classList.add('hidden');
            ui.uiLayer.style.display = 'flex';
        });

        function enableMouseControl() {
            const container = document.getElementById('canvas-container');
            container.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                if (useMouseControl && currentState !== STATE.INTRO && !galaxyMode) {
                    handGesture = 'fist';
                }
            });
            window.addEventListener('mouseup', (e) => {
                if (e.button !== 0) return;
                if (useMouseControl && currentState !== STATE.INTRO && !galaxyMode) {
                    handGesture = 'palm';
                }
            });
            container.addEventListener('touchstart', (e) => {
                if (useMouseControl && currentState !== STATE.INTRO && !galaxyMode) {
                    handGesture = 'fist';
                }
            }, {passive: true});
            window.addEventListener('touchend', (e) => {
                if (useMouseControl && currentState !== STATE.INTRO && !galaxyMode) {
                    handGesture = 'palm';
                }
            });
        }

        // é”®ç›˜äº‹ä»¶ç›‘å¬ï¼ˆä¿ç•™è°ƒè¯•åŠŸèƒ½ï¼‰
        document.addEventListener('keydown', (e) => {
            if (e.key === '1') {
                if (currentState !== STATE.INTRO && !videoMode) {
                    galaxyMode = !galaxyMode;
                    log(`é“¶æ²³æ¨¡å¼: ${galaxyMode ? 'å¼€å¯' : 'å…³é—­'}`);
                    ui.statusText.innerText = galaxyMode ? "GALAXY MODE ON" : "GALAXY MODE OFF";
                    if (galaxyMode) {
                        galaxyTargets = generateGalaxyTargets();
                        playMusic(bgmGalaxy);
                        // å¦‚æœä¹‹å‰æœ‰ç…§ç‰‡ç´¢å¼•ï¼Œé‡æ–°æ˜¾ç¤º
                        if (photoActive) {
                            showPhoto(currentPhotoIndex);
                        }
                    } else {
                        galaxyTargets = null;
                        hidePhoto(); // ç¦»å¼€é“¶æ²³æ¨¡å¼éšè—ç…§ç‰‡
                        if (currentState !== STATE.CELEBRATION) {
                            playMusic(bgmMain);
                        }
                    }
                }
            }
            if (e.key === 'o' || e.key === 'O') {
                if (galaxyMode && !photoActive && !videoMode) {
                    // éšæœºé€‰ä¸€å¼ å¹¶æ˜¾ç¤º
                    currentPhotoIndex = Math.floor(Math.random() * photoList.length);
                    showPhoto(currentPhotoIndex);
                    log('OKæ‰‹åŠ¿æ¨¡æ‹ŸæŒ‰ä¸‹ï¼Œç…§ç‰‡æ˜¾ç¤º');
                } else if (galaxyMode && photoActive) {
                    // å¦‚æœå·²ç»æ˜¾ç¤ºï¼Œå¯ä»¥å†æ¬¡éšæœºï¼Ÿæ ¹æ®éœ€æ±‚ï¼Œæš‚æ—¶ä¸åš
                }
            }
            if (e.key === 'ArrowLeft') {
                if (galaxyMode && photoActive) prevPhoto();
            }
            if (e.key === 'ArrowRight') {
                if (galaxyMode && photoActive) nextPhoto();
            }
            if (e.key === '2') {
                if (currentState !== STATE.INTRO) {
                    toggleVideoMode(!videoMode);
                }
            }
        });
        document.addEventListener('keyup', (e) => {
            // ç§»é™¤OKæ¾å¼€æ¸…é™¤ç…§ç‰‡çš„é€»è¾‘
        });

        async function initAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);
                checkAudio();
            } catch (e) {
                log('éº¦å…‹é£æƒé™è¢«æ‹’ç»');
                ui.statusText.innerText = "MIC DENIED - USE TOUCH/SPACE";
                throw e;
            }
        }

        document.addEventListener('touchstart', (e) => {
            if(currentState === STATE.BLOWING && !e.target.closest('button') && !e.target.closest('input')) {
                isTouching = true;
            }
        }, {passive: false});

        document.addEventListener('touchend', () => isTouching = false);
        document.addEventListener('touchcancel', () => isTouching = false);
        document.addEventListener('keydown', (e) => { 
            if(e.code === 'Space') isSpacePressed = true; 
        });
        document.addEventListener('keyup', (e) => { 
            if(e.code === 'Space') isSpacePressed = false; 
        });

        function checkAudio() {
            requestAnimationFrame(checkAudio);
            if (currentState !== STATE.BLOWING) return;
            let volume = 0;
            if (analyser) {
                const data = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(data);
                let sum = 0; for(let i=0; i<data.length; i++) sum += data[i];
                volume = sum / data.length;
            }
            if (volume > VISUAL_CONFIG.blowThreshold || isSpacePressed || isTouching) {
                blowProgress += 0.8; 
            } else {
                blowProgress -= 0.3; 
            }
            blowProgress = Math.max(0, Math.min(100, blowProgress));
            ui.blowBar.style.width = blowProgress + '%';
            if (blowProgress >= 100) successCelebration();
        }

        function fadeAudioIn() {
            playMusic(bgmMain);
        }
        
        document.getElementById('music-btn').addEventListener('click', () => {
            if (currentMusic) {
                if (currentMusic.paused) currentMusic.play(); else currentMusic.pause();
            } else {
                playMusic(bgmMain);
            }
        });

        async function initCamera() {
            const video = document.getElementsByClassName('input_video')[0];
            
            if (typeof Hands === 'undefined' || typeof Camera === 'undefined') {
                throw new Error("MediaPipe åº“æœªåŠ è½½");
            }

            const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`});
            
            hands.setOptions({ 
                maxNumHands: 1, 
                modelComplexity: 0, 
                minDetectionConfidence: 0.5, 
                minTrackingConfidence: 0.5 
            });
            
            hands.onResults((results) => {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const landmarks = results.multiHandLandmarks[0];
                    
                    // æ‰‹åŠ¿è¯†åˆ«
                    const wrist = landmarks[0];
                    const tipIndices = [4, 8, 12, 16, 20];
                    const mcpIndices = [2, 5, 9, 13, 17];
                    
                    let fingerRatios = [];
                    for (let f = 0; f < 5; f++) {
                        const tip = landmarks[tipIndices[f]];
                        const mcp = landmarks[mcpIndices[f]];
                        const tipDist = Math.sqrt((tip.x - wrist.x)**2 + (tip.y - wrist.y)**2);
                        const mcpDist = Math.sqrt((mcp.x - wrist.x)**2 + (mcp.y - wrist.y)**2);
                        fingerRatios.push(tipDist / mcpDist);
                    }
                    
                    const fistThreshold = 1.5;
                    const palmThreshold = 2.2;
                    
                    const isFist = fingerRatios.every(r => r < fistThreshold);
                    const isPalm = fingerRatios.every(r => r > palmThreshold);
                    
                    const oneThreshold = 2.0;
                    const isOne = (fingerRatios[1] > oneThreshold) && 
                                 fingerRatios.slice(2).every(r => r < fistThreshold);
                    
                    const thumbTip = landmarks[4];
                    const indexTip = landmarks[8];
                    const dx = thumbTip.x - indexTip.x;
                    const dy = thumbTip.y - indexTip.y;
                    const dz = thumbTip.z - indexTip.z;
                    const thumbIndexDist = Math.sqrt(dx*dx + dy*dy + dz*dz);
                    const okDistThreshold = 0.15;
                    const isOkPinch = thumbIndexDist < okDistThreshold;
                    const otherFingersStraight = fingerRatios[2] > 1.8 && fingerRatios[3] > 1.8 && fingerRatios[4] > 1.8;
                    const isOk = isOkPinch && otherFingersStraight;

                    const yaThreshold = 1.8;
                    const isIndexStraight = fingerRatios[1] > yaThreshold;
                    const isMiddleStraight = fingerRatios[2] > yaThreshold;
                    const isRingBent = fingerRatios[3] < 1.5;
                    const isPinkyBent = fingerRatios[4] < 1.5;
                    const isThumbBent = fingerRatios[0] < 1.5;
                    const isYa = isIndexStraight && isMiddleStraight && isRingBent && isPinkyBent && isThumbBent;
                    
                    if (isOk) {
                        handGesture = 'ok';
                        // ä¿®æ”¹ï¼šOKæ‰‹åŠ¿åœ¨é“¶æ²³æ¨¡å¼ä¸‹å¬å”¤ç…§ç‰‡ï¼ˆå¦‚æœå°šæœªæ˜¾ç¤ºï¼‰
                        if (galaxyMode && !photoActive && !videoMode) {
                            currentPhotoIndex = Math.floor(Math.random() * photoList.length);
                            showPhoto(currentPhotoIndex);
                        }
                        // é‡ç½®å…¶ä»–æ‰‹åŠ¿æ ‡å¿—
                        lastOneGesture = false;
                        lastYaGesture = false;
                    } else if (isYa) {
                        handGesture = 'ya';
                        // è¾¹ç¼˜æ£€æµ‹ï¼šåªæœ‰åˆšå‡ºç°æ—¶æ‰è§¦å‘
                        if (!lastYaGesture) {
                            const now = Date.now();
                            if (now - lastYaSwitchTime > 3000) { // å†·å´3ç§’
                                lastYaSwitchTime = now;
                                toggleVideoMode(!videoMode);
                            }
                        }
                        lastYaGesture = true;
                        lastOneGesture = false;
                    } else {
                        // ä¸å†åœ¨éOKæ‰‹åŠ¿æ—¶è‡ªåŠ¨éšè—ç…§ç‰‡ï¼ˆä¿æŒæ˜¾ç¤ºï¼‰
                        if (isOne) {
                            handGesture = 'one';
                            // è¾¹ç¼˜æ£€æµ‹ï¼šåªæœ‰åˆšå‡ºç°æ—¶æ‰è§¦å‘
                            if (!lastOneGesture) {
                                const now = Date.now();
                                if (now - lastOneSwitchTime > 3000) { // å†·å´3ç§’
                                    lastOneSwitchTime = now;
                                    // åˆ‡æ¢é“¶æ²³æ¨¡å¼ï¼Œå¹¶ç¡®ä¿è§†é¢‘æ¨¡å¼å…³é—­
                                    galaxyMode = !galaxyMode;
                                    if (galaxyMode) {
                                        if (videoMode) toggleVideoMode(false);
                                        galaxyTargets = generateGalaxyTargets();
                                        playMusic(bgmGalaxy);
                                        // å¦‚æœä¹‹å‰æœ‰ç…§ç‰‡ç´¢å¼•ï¼Œé‡æ–°æ˜¾ç¤ºï¼ˆç…§ç‰‡æœªéšè—ï¼‰
                                        if (photoActive) {
                                            showPhoto(currentPhotoIndex);
                                        }
                                    } else {
                                        galaxyTargets = null;
                                        hidePhoto(); // ç¦»å¼€é“¶æ²³æ¨¡å¼éšè—ç…§ç‰‡
                                        if (currentState !== STATE.CELEBRATION) playMusic(bgmMain);
                                    }
                                    ui.statusText.innerText = galaxyMode ? "GALAXY MODE ON" : "GALAXY MODE OFF";
                                }
                            }
                            lastOneGesture = true;
                            lastYaGesture = false;
                        } else if (isFist) {
                            handGesture = 'fist';
                            // æ¡æ‹³å¼€å§‹ç”Ÿæ—¥æµç¨‹
                            if (currentState === STATE.IDLE) {
                                startSequence();
                            }
                            lastOneGesture = false;
                            lastYaGesture = false;
                        } else if (isPalm) {
                            handGesture = 'palm';
                            lastOneGesture = false;
                            lastYaGesture = false;
                        } else {
                            handGesture = 'unknown';
                            lastOneGesture = false;
                            lastYaGesture = false;
                        }
                    }
                    
                    ui.camStatusDot.className = "w-1.5 h-1.5 rounded-full bg-green-400 shadow-[0_0_8px_#4ade80]";
                    ui.camStatusText.innerText = handGesture.toUpperCase();
                    ui.camStatusText.className = "text-[8px] text-green-400 font-mono font-bold";
                    
                    if (interactionMode === 1 && !galaxyMode && !videoMode) {
                        const currentHandX = landmarks[9].x; 
                        const delta = currentHandX - lastHandX;
                        if (Math.abs(delta) > 0.002) {
                            rotationVelocity += delta * -0.4; 
                        }
                        lastHandX = currentHandX;
                    }
                } else {
                    if (!useMouseControl) {
                        handGesture = 'unknown';
                    }
                    lastOneGesture = false;
                    lastYaGesture = false;
                    // æ²¡æœ‰æ‰‹æ—¶ä¸éšè—ç…§ç‰‡ï¼ˆç…§ç‰‡ä¿ç•™ï¼‰
                    ui.camStatusDot.className = "w-1.5 h-1.5 rounded-full bg-red-500";
                    ui.camStatusText.innerText = "NO HAND";
                    ui.camStatusText.className = "text-[8px] text-red-400 font-mono";
                }

                const ctx = document.getElementById('output_canvas').getContext('2d');
                ctx.clearRect(0, 0, 160, 120);
                if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                     for (const l of results.multiHandLandmarks) {
                         drawConnectors(ctx, l, HAND_CONNECTIONS, {color: '#ff69b4', lineWidth: 2});
                     }
                }
            });

            const camera = new Camera(video, { 
                onFrame: async () => { await hands.send({image: video}); }, 
                width: 320, 
                height: 240 
            });
            
            return camera.start();
        }

        function render() {
            requestAnimationFrame(render);
            if (!videoMode) {
                updateParticles();
                renderer.render(scene, camera);
            } else {
                renderer.clear();
            }
        }
    </script>
</body>
</html>
